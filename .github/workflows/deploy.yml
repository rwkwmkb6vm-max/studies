name: IOS-XR GitOps Demo

on:
  push:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: .
          submodules: false
          clean: true
          fetch-depth: 0
          persist-credentials: false
          lfs: false
          ref: ${{ github.sha }}

      - name: Remove leftover submodule metadata
        run: |
          rm -rf .git/modules || true
          rm -f .git/config.worktree || true
          git config --unset-all submodule || true

      - name: Prepare Python + CA bundle
        shell: bash
        run: |
          python3 --version
          python3 -m pip install --upgrade pip certifi
          CACERT=$(python3 -c "import certifi; print(certifi.where())")
          echo "SSL_CERT_FILE=$CACERT" >> $GITHUB_ENV
          echo "REQUESTS_CA_BUNDLE=$CACERT" >> $GITHUB_ENV

      - name: Install system dependencies for pylibssh
        shell: bash
        run: |
          brew update
          brew install libssh openssl pkg-config

      - name: Install Ansible + pylibssh (Python 3.13)
        shell: bash
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install "ansible>=10,<11"
          python3 -m pip install ansible-pylibssh

      - name: Force-install pylibssh into Ansible's Python
        shell: bash
        run: |
           echo "ANSIBLE_PYTHON_INTERPRETER=$(which python3)" >> $GITHUB_ENV


      - name: Force Ansible to use Python 3.13
        shell: bash
        run: |
          echo "ANSIBLE_PYTHON_INTERPRETER=$(which python3)" >> $GITHUB_ENV

      - name: Install IOS-XR collection
        shell: bash
        env:
          SSL_CERT_FILE: ${{ env.SSL_CERT_FILE }}
          REQUESTS_CA_BUNDLE: ${{ env.REQUESTS_CA_BUNDLE }}
        run: |
          ansible-galaxy collection install cisco.iosxr --force

      - name: Run playbook
        shell: bash
        env:
          XR_USERNAME: "ansible"
          XR_PASSWORD: "ansible"
          SSL_CERT_FILE: ${{ env.SSL_CERT_FILE }}
          REQUESTS_CA_BUNDLE: ${{ env.REQUESTS_CA_BUNDLE }}
          ANSIBLE_PYTHON_INTERPRETER: ${{ env.ANSIBLE_PYTHON_INTERPRETER }}
          ANSIBLE_HOST_KEY_CHECKING: "False"
          ANSIBLE_PERSISTENT_CONNECT_TIMEOUT: "30"
          ANSIBLE_PERSISTENT_COMMAND_TIMEOUT: "120"
        run: |
          ansible-playbook -i inventory/hosts.yml playbooks/isis.yml -vv

